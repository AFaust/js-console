if(typeof Fme=="undefined"||!Fme){var Fme={};}(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event,Element=YAHOO.util.Element;var $html=Alfresco.util.encodeHTML,$hasEventInterest=Alfresco.util.hasEventInterest;Fme.JavascriptConsole=function(htmlId){this.name="Fme.JavascriptConsole";Fme.JavascriptConsole.superclass.constructor.call(this,htmlId);Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datasource","datatable","paginator","json","history","tabview"],this.onComponentsLoaded,this);var parent=this;ListPanelHandler=function ListPanelHandler_constructor(){ListPanelHandler.superclass.constructor.call(this,"main");};YAHOO.extend(ListPanelHandler,Alfresco.ConsolePanelHandler,{onLoad:function onLoad(){parent.widgets.pathField=Dom.get(parent.id+"-pathField");parent.widgets.documentField=Dom.get(parent.id+"-documentField");parent.widgets.nodeField=Dom.get(parent.id+"-nodeRef");parent.widgets.scriptInput=Dom.get(parent.id+"-jsinput");parent.widgets.scriptOutput=Dom.get(parent.id+"-jsoutput");parent.widgets.jsonOutput=Dom.get(parent.id+"-jsonOutput");parent.widgets.templateInput=Dom.get(parent.id+"-templateinput");parent.widgets.templateOutputHtml=Dom.get(parent.id+"-templateoutputhtml");parent.widgets.templateOutputText=Dom.get(parent.id+"-templateoutputtext");parent.widgets.config={runas:Dom.get(parent.id+"-runas"),transaction:Dom.get(parent.id+"-transactions"),urlargs:Dom.get(parent.id+"-urlarguments"),runlikecrazy:Dom.get(parent.id+"-runlikecrazy")};parent.widgets.selectDestinationButton=Alfresco.util.createYUIButton(parent,"selectDestination-button",parent.onSelectDestinationClick);parent.widgets.executeButton=Alfresco.util.createYUIButton(parent,"execute-button",parent.onExecuteClick);}});new ListPanelHandler();return this;};YAHOO.extend(Fme.JavascriptConsole,Alfresco.ConsoleTool,{clearOutput:function ACJC_clearOutput(){this.widgets.scriptOutput.innerHTML="";this.widgets.templateOutputHtml.innerHTML="";this.widgets.templateOutputText.innerHTML="";},template:'<div class="display-element"><span class="display-label">{name}</span><span class="display-field">{value}</span></div>',appendLineArrayToOutput:function ACJC_appendLineArrayToOutput(lineArray){var newLines="";for(line in lineArray){newLines=newLines+lineArray[line]+"\n";}this.setOutputText(newLines);},setOutputText:function(text){var outputfield=this.widgets.scriptOutput;outputfield.innerHTML="";outputfield.appendChild(document.createTextNode(text));},browserSupportsHtml5Storage:function ACJC_browserSupportsHtml5Storage(){try{var testString="LSTEST12345";localStorage.setItem(testString,testString);localStorage.removeItem(testString);return true;}catch(e){return false;}},createMenuButtons:function ACJC_createMenuButtons(listOfScripts){var themeMenuItems=[{text:"default",value:"default"},{text:"ambiance-mobile",value:"ambiance-mobile"},{text:"ambiance",value:"ambiance"},{text:"blackboard",value:"blackboard"},{text:"cobalt",value:"cobalt"},{text:"eclipse",value:"eclipse"},{text:"erlang-dark",value:"erlang-dark"},{text:"lesser-dark",value:"lesser-dark"},{text:"monokai",value:"monokai"},{text:"neat",value:"neat"},{text:"rubyblue",value:"rubyblue"},{text:"solarized",value:"solarized"},{text:"twilight",value:"twilight"},{text:"vibrant-ink",value:"vibrant-ink"},{text:"xq-dark",value:"xq-dark"}];var othemeMenuButton=new YAHOO.widget.Button({id:"themeButton",name:"themeButton",label:this.msg("button.codemirror.theme"),type:"menu",menu:themeMenuItems,container:this.id+"-theme"});if(this.browserSupportsHtml5Storage()){var theme=window.localStorage["javascript.console.codemirror.theme"];if(theme){var menuItems=othemeMenuButton.getMenu().getItems();for(var i=0;i<menuItems.length;i++){var menuItem=menuItems[i];if(theme==menuItem.cfg.getProperty("text")){menuItem.cfg.setProperty("selected",true);}}}}othemeMenuButton.getMenu().subscribe("click",this.onThemeSelection,this);var loadMenuItems=[{text:this.msg("button.load.create.new"),value:"NEW"}];loadMenuItems.push(listOfScripts);var oLoadMenuButton=new YAHOO.widget.Button({id:"loadButton",name:"loadButton",label:this.msg("button.load.script"),type:"menu",menu:loadMenuItems,container:this.id+"-scriptload"});oLoadMenuButton.getMenu().subscribe("click",this.onLoadScriptClick,this);var saveMenuItems=[{text:this.msg("button.save.create.new"),value:"NEW"}];saveMenuItems.push(listOfScripts);var oSaveMenuButton=new YAHOO.widget.Button({id:"saveButton",name:"saveButton",label:this.msg("button.save.script"),type:"menu",menu:saveMenuItems,container:this.id+"-scriptsave"});oSaveMenuButton.getMenu().subscribe("click",this.onSaveScriptClick,this);var docsMenuItems=[[{text:"Mozilla Javascript Reference",url:"https://developer.mozilla.org/en/JavaScript/Reference",target:"_blank"},{text:"W3Schools Javascript Reference",url:"http://www.w3schools.com/jsref/default.asp",target:"_blank"},{text:"Alfresco 3.4 Javascript API",url:"http://wiki.alfresco.com/wiki/3.4_JavaScript_API",target:"_blank"},{text:"Alfresco 3.4 Javascript Services API",url:"http://wiki.alfresco.com/wiki/3.4_JavaScript_Services_API",target:"_blank"},{text:"Alfresco 4.0 Javascript API",url:"http://docs.alfresco.com/4.0/topic/com.alfresco.enterprise.doc/references/API-JS-Scripting-API.html",target:"_blank"},{text:"Alfresco 4.0 Javascript Services API",url:"http://docs.alfresco.com/4.0/topic/com.alfresco.enterprise.doc/references/API-JS-Services.html",target:"_blank"},{text:"Alfresco Javascript Cookbook",url:"http://wiki.alfresco.com/wiki/JavaScript_API_Cookbook",target:"_blank"}],[{text:"Alfresco Freemarker Template Guide",url:"http://wiki.alfresco.com/wiki/Template_Guide",target:"_blank"},{text:"Freemarker Manual",url:"http://freemarker.sourceforge.net/docs/index.html",target:"_blank"}],[{text:"Lucene Search Reference",url:"http://wiki.alfresco.com/wiki/Search",target:"_blank"}],[{text:"Webscripts Reference",url:"http://wiki.alfresco.com/wiki/Web_Scripts",target:"_blank"},{text:"Webscripts Examples",url:"http://wiki.alfresco.com/wiki/Web_Scripts_Examples",target:"_blank"}]];var oDocsMenuButton=new YAHOO.widget.Button({id:"docsButton",name:"docsButton",label:this.msg("button.docs"),type:"menu",menu:docsMenuItems,container:this.id+"-documentation"});oDocsMenuButton.getMenu().setItemGroupTitle("Javascript",0);oDocsMenuButton.getMenu().setItemGroupTitle("Freemarker",1);oDocsMenuButton.getMenu().setItemGroupTitle("Lucene",2);oDocsMenuButton.getMenu().setItemGroupTitle("Webscripts",3);this.widgets.exportResultsButton=Alfresco.util.createYUIButton(this,"exportResults-button",this.exportResultTableAsCSV);Dom.setStyle(this.widgets.exportResultsButton,"display","none");},onEditorKeyEvent:function ACJC_onEditorKeyEvent(i,e){if(e.type=="keyup"&&e.keyCode==13&&(e.ctrlKey||e.metaKey)&&!e.altKey){e.stop();i.owner.onExecuteClick(i.owner,e);}if(e.keyCode==122&&(e.ctrlKey||e.metaKey)&&!e.altKey){e.stop();i.owner.widgets.codeMirrorScript.undo(i.owner,e);}if(e.keyCode==123&&(e.ctrlKey||e.metaKey)&&!e.altKey){e.stop();i.owner.widgets.codeMirrorScript.redo(i.owner,e);}if(e.type=="keydown"&&e.keyCode==55&&(e.ctrlKey||e.metaKey)&&!e.altKey){e.stop();var editor=i.owner.widgets.codeMirrorScript;var code=editor.getSelection();if(code.substr(0,2)=="//"){code=code.replace(/^\/\//gm,"");}else{code=code.replace(/^/gm,"//");}editor.replaceSelection(code);}if(e.type=="keydown"&&e.keyCode==70&&(e.ctrlKey||e.metaKey)&&!e.altKey){e.stop();var editor=i.owner.widgets.codeMirrorScript;editor.setValue(js_beautify(editor.getValue()));}},onReady:function ACJC_onReady(){Fme.JavascriptConsole.superclass.onReady.call(this);var self=this;this.javascriptCommands=new Object();this.widgets.codeMirrorScript=CodeMirror.fromTextArea(this.widgets.scriptInput,{mode:"javascript",styleActiveLine:true,highlightSelectionMatches:true,showCursorWhenSelecting:true,gutters:["CodeMirror-lint-markers"],lintWith:function(text){return CodeMirror.javascriptValidator(text,self.javascriptCommands.globalMap);},lineNumbers:true,matchBrackets:true,autoCloseBrackets:true,onKeyEvent:this.onEditorKeyEvent,extraKeys:{"Ctrl-Space":"autocomplete"}});this.widgets.codeMirrorScript.on("cursorActivity",function(cm){var currentLine=cm.getCursor().line+1;var column=cm.getCursor().ch;var results=CodeMirror.javascriptValidator(cm.getDoc().getValue(),self.javascriptCommands.globalMap);var info="Line "+currentLine+" \t - Column "+column+" \t - Errors/Warnings "+results.length;var text=YAHOO.util.Selector.query(".scriptStatusLine",null,true);text.innerHTML=info;});this.widgets.codeMirrorScript.getInputField().blur();this.widgets.codeMirrorTemplate=CodeMirror.fromTextArea(this.widgets.templateInput,{lineNumbers:true,mode:"htmlmixed",styleActiveLine:true,highlightSelectionMatches:true,showCursorWhenSelecting:true,matchBrackets:true,autoCloseBrackets:true,onKeyEvent:this.onEditorKeyEvent,markParen:function(node,ok){node.style.backgroundColor=ok?"#CCF":"#FCC#";if(!ok){node.style.color="red";}},unmarkParen:function(node){node.style.backgroundColor="";node.style.color="";},indentUnit:4});this.widgets.codeMirrorTemplate.on("cursorActivity",function(cm){var currentLine=cm.getCursor().line+1;var column=cm.getCursor().ch;var info="Line "+currentLine+" \t - Column "+column;var text=YAHOO.util.Selector.query(".templateStatusLine",null,true);text.innerHTML=info;});this.widgets.codeMirrorTemplate.getInputField().blur();this.widgets.codeMirrorJSON=CodeMirror.fromTextArea(this.widgets.jsonOutput,{mode:"application/json",styleActiveLine:true,readOnly:true,showCursorWhenSelecting:true,highlightSelectionMatches:true,gutters:["CodeMirror-lint-markers"],lintWith:CodeMirror.jsonValidator,lineNumbers:true,matchBrackets:true,onKeyEvent:this.onEditorKeyEvent});this.widgets.codeMirrorJSON.on("cursorActivity",function(cm){var currentLine=cm.getCursor().line+1;var column=cm.getCursor().ch;var results=CodeMirror.jsonValidator(cm.getDoc().getValue(),self.javascriptCommands.globalMap);var info="Line "+currentLine+" \t - Column "+column+" \t - Errors/Warnings "+results.length;var text=YAHOO.util.Selector.query(".jsonStatusLine",null,true);text.innerHTML=info;});this.widgets.codeMirrorScript.owner=this;this.widgets.codeMirrorTemplate.owner=this;this.javascriptKeywords=("break case catch continue debugger default delete do else false finally for function if in instanceof new null return switch throw true try typeof var void while with").split(" ");CodeMirror.commands.autocomplete=function(cm){CodeMirror.showHint(cm,function(editor,options){return self.scriptHint(editor,self.javascriptKeywords,function(e,cur){return e.getTokenAt(cur);},options);});};this.setupResizableEditor();this.widgets.inputTabs=new YAHOO.widget.TabView(this.id+"-inputTabs");this.widgets.outputTabs=new YAHOO.widget.TabView(this.id+"-outputTabs");var jsonView=this.widgets.codeMirrorJSON;this.widgets.outputTabs.getTab(3).addListener("activeChange",function(event){if(event.newValue){YAHOO.lang.later(50,undefined,function(){jsonView.refresh();});}});new YAHOO.widget.Tooltip("tooltip-urlargs",{context:this.widgets.config.urlargs,text:this.msg("tooltip.urlargs"),showDelay:200});new YAHOO.widget.Tooltip("tooltip-runas",{context:this.widgets.config.runas,text:this.msg("tooltip.runas"),showDelay:200});var tab0=this.widgets.inputTabs.getTab(1);tab0.addListener("click",function handleClick(e){self.widgets.codeMirrorTemplate.refresh();});this.widgets.statsModule=new YAHOO.widget.Module("perfPanel",{visible:true,draggable:false,close:false});this.widgets.statsModule.setHeader("Performance Stats");var noExecEl=YAHOO.lang.substitute(this.template,{name:this.msg("label.stats.no.execution"),value:""});this.widgets.statsModule.setBody(noExecEl);this.widgets.statsModule.render(this.id+"-executionStats");YAHOO.Bubbling.on("folderSelected",this.onDestinationSelected,this);if(self.browserSupportsHtml5Storage()){window.onbeforeunload=function(e){self.widgets.codeMirrorScript.save();window.localStorage["javascript.console.script"]=self.widgets.scriptInput.value;self.widgets.codeMirrorTemplate.save();window.localStorage["javascript.console.template"]=self.widgets.templateInput.value;if(self.widgets.config.runas){window.localStorage["javascript.console.config.runas"]=self.widgets.config.runas.value;}if(self.widgets.config.transactions){window.localStorage["javascript.console.config.transactions"]=self.widgets.config.transactions.value;}if(self.widgets.config.urlarguments){window.localStorage["javascript.console.config.urlarguments"]=self.widgets.config.urlarguments.value;}if(self.widgets.config.runlikecrazy){window.localStorage["javascript.console.config.runlikecrazy"]=self.widgets.config.runlikecrazy.value;}window.localStorage["javascript.console.codemirror.theme"]=self.widgets.codeMirrorScript.options.theme;};if(window.localStorage["javascript.console.config.runas"]){self.widgets.config.runas.value=window.localStorage["javascript.console.config.runas"];}if(window.localStorage["javascript.console.config.transactions"]){self.widgets.config.transactions.value=window.localStorage["javascript.console.config.transactions"];}if(window.localStorage["javascript.console.config.urlarguments"]){self.widgets.config.urlarguments.value=window.localStorage["javascript.console.config.urlarguments"];}if(window.localStorage["javascript.console.config.runlikecrazy"]){self.widgets.config.runlikecrazy.value=window.localStorage["javascript.console.config.runlikecrazy"];}if(window.localStorage["javascript.console.script"]){var javascriptText=window.localStorage["javascript.console.script"];this.widgets.codeMirrorScript.setValue(javascriptText);}else{this.loadDemoScript();}if(window.localStorage["javascript.console.template"]){this.widgets.codeMirrorTemplate.setValue(window.localStorage["javascript.console.template"]);}else{this.loadDemoTemplate();}if(window.localStorage["javascript.console.codemirror.theme"]){var theme=window.localStorage["javascript.console.codemirror.theme"];this.widgets.codeMirrorScript.setOption("theme",theme);this.widgets.codeMirrorTemplate.setOption("theme",theme);}}Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"de/fme/jsconsole/listscripts.json",method:Alfresco.util.Ajax.GET,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(res){var listOfScripts=res.json.scripts;this.createMenuButtons(listOfScripts);},scope:this}});Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"de/fme/jsconsole/apicommands.json",method:Alfresco.util.Ajax.GET,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(res){this.javascriptCommands=res.json;this.javascriptCommands.globalMap={};for(var i=0;i<this.javascriptCommands.global.length;i++){this.javascriptCommands.globalMap[this.javascriptCommands.global[i]]=false;}this.javascriptCommands.globalMap.Packages=false;},scope:this}});Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/classes",method:Alfresco.util.Ajax.GET,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(res){this.dictionary=res.json;},scope:this}});var getQueryVariable=function getQueryVariable(variable){var query=window.location.search.substring(1);var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(pair[0]==variable){return unescape(pair[1]);}}return"";};this.options.documentNodeRef=getQueryVariable("nodeRef");this.options.documentName=getQueryVariable("name");if(this.options.documentNodeRef||this.options.documentName){Dom.setStyle(Dom.get(this.id+"-documentDisplay"),"display","inline");this.widgets.documentField.innerHTML=this.options.documentName+" ("+this.options.documentNodeRef+")";}},scriptHint:function(editor,keywords,getToken,options){var cur=editor.getCursor(),token=getToken(editor,cur),tprop=token;if(!/^[\w$_]*$/.test(token.string)){token=tprop={start:cur.ch,end:cur.ch,string:"",state:token.state,type:token.string=="."?"property":null};}while(tprop.type=="property"){tprop=getToken(editor,CodeMirror.Pos(cur.line,tprop.start));if(tprop.string!="."){return;}tprop=getToken(editor,CodeMirror.Pos(cur.line,tprop.start));if(tprop.string==")"){var level=1;do{tprop=getToken(editor,CodeMirror.Pos(cur.line,tprop.start));switch(tprop.string){case")":level++;break;case"(":level--;break;default:break;}}while(level>0);tprop=getToken(editor,CodeMirror.Pos(cur.line,tprop.start));if(tprop.type.indexOf("variable")===0){tprop.type="function";}else{return;}}if(!context){var context=[];}context.push(tprop);}return{list:this.getCompletions(token,context,keywords,options),from:CodeMirror.Pos(cur.line,token.start),to:CodeMirror.Pos(cur.line,token.end)};},getCompletions:function(token,context,keywords,options){var found=[],start=token.string;function maybeAdd(str){if(str.indexOf(start)==0&&!arrayContains(found,str)){found.push(str);}}if(context){var obj=context.pop();var commands=this.javascriptCommands.methods[obj.string];if(commands){forEach(commands,maybeAdd);}else{if(obj.string.substr(-4).toLowerCase()==="node"){forEach(this.javascriptCommands.node,maybeAdd);}}}else{if(token.className=="stringliteral"){var suggestions={};for(var t in this.dictionary){var info={type:(this.dictionary[t].isAspect?"Aspect":"Type"),name:this.dictionary[t].name};suggestions[info.type+info.name]=info;for(var p in this.dictionary[t].properties){info={type:"Property",name:this.dictionary[t].properties[p].name};suggestions[info.type+info.name]=info;}}for(var sg in suggestions){maybeAdd(suggestions[sg].name,suggestions[sg].type);}}else{forEach(this.javascriptCommands.global,maybeAdd);forEach(keywords,maybeAdd);}}return found;},setupResizableEditor:function(){var me=this;var codeMirrorScript=this.widgets.codeMirrorScript;var codeMirrorTemplate=this.widgets.codeMirrorTemplate;var resize=new YAHOO.util.Resize(this.id+"-inputContentArea",{handles:["b"]});resize.on("resize",function(ev){var h=ev.height;Dom.setStyle(codeMirrorScript.getScrollerElement(),"height",""+h-20+"px");codeMirrorScript.refresh();Dom.setStyle(codeMirrorTemplate.getScrollerElement(),"height",""+h-20+"px");codeMirrorTemplate.refresh();Dom.setStyle(me.id+"-inputContentArea","width","inherit");});resize.on("endResize",function(ev){Dom.setStyle(me.id+"-inputContentArea","width","inherit");});YAHOO.util.Event.on(window,"resize",function(e){Dom.setStyle(me.id+"-inputContentArea","width","inherit");},this,true);},showResultTable:function ACJC_showResultTable(resultData){var allFields={};for(var row in resultData){for(var fieldname in resultData[row]){allFields[fieldname]=1;}}var myColumnDefs=[];var responseSchemaFields=[];for(var fieldname in allFields){responseSchemaFields.push(fieldname);myColumnDefs.push({key:fieldname,sortable:true,resizeable:true});}if(myColumnDefs.length>0){var myDataSource=new YAHOO.util.DataSource(resultData);myDataSource.responseType=YAHOO.util.DataSource.TYPE_JSARRAY;myDataSource.responseSchema={fields:responseSchemaFields};Dom.setStyle(this.id+"-datatable","display","block");this.widgets.resultTable=new YAHOO.widget.DataTable(this.id+"-datatable",myColumnDefs,myDataSource,{draggableColumns:true});Dom.setStyle(this.widgets.exportResultsButton,"display","inline-block");}else{Dom.setStyle(this.id+"-datatable","display","none");this.widgets.resultTable=null;Dom.setStyle(this.widgets.exportResultsButton,"display","none");}},exportResultTableAsCSV:function(){var myDataTable=this.widgets.resultTable;if(myDataTable){var i,j,oData,newWin=window.open(),aRecs=myDataTable.getRecordSet().getRecords(),aCols=myDataTable.getColumnSet().keys;newWin.document.write("<pre>");for(j=0;j<aCols.length;j++){newWin.document.write(aCols[j].key+"\t");}newWin.document.write("\n");for(i=0;i<aRecs.length;i++){oData=aRecs[i].getData();for(j=0;j<aCols.length;j++){newWin.document.write(oData[aCols[j].key]+"\t");}newWin.document.write("\n");}newWin.document.write("</pre>\n");newWin.document.close();}},onExecuteClick:function ACJC_onExecuteClick(e,p_obj){this.widgets.codeMirrorScript.save();this.widgets.codeMirrorTemplate.save();var scriptCode="";if(this.widgets.codeMirrorScript.somethingSelected()){scriptCode=this.widgets.codeMirrorScript.getSelection();}else{scriptCode=this.widgets.scriptInput.value;}templateCode=this.widgets.templateInput.value;var input={script:scriptCode,template:templateCode,spaceNodeRef:this.widgets.nodeField.value,transaction:this.widgets.config.transaction.value?this.widgets.config.transaction.value:"readwrite",runas:this.widgets.config.runas.value?this.widgets.config.runas.value:"admin",urlargs:this.widgets.config.urlargs.value?this.widgets.config.urlargs.value:"",documentNodeRef:this.options.documentNodeRef};this.widgets.scriptOutput.disabled=true;this.widgets.executeButton.disabled=true;this.showLoadingAjaxSpinner(true);this.executeStartTime=new Date();Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"de/fme/jsconsole/execute",method:Alfresco.util.Ajax.POST,dataObj:input,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(res){this.showLoadingAjaxSpinner(false);this.printExecutionStats(res.json);this.clearOutput();this.appendLineArrayToOutput(res.json.printOutput);this.widgets.templateOutputHtml.innerHTML=res.json.renderedTemplate;this.widgets.templateOutputText.innerHTML=$html(res.json.renderedTemplate);this.widgets.codeMirrorJSON.setValue(formatter.formatJson(res.json.renderedTemplate,"  "));this.widgets.codeMirrorJSON.focus();if(res.json.spaceNodeRef){this.widgets.nodeField.value=res.json.spaceNodeRef;this.widgets.pathField.innerHTML=res.json.spacePath;}this.widgets.scriptOutput.disabled=false;this.widgets.templateOutputHtml.disabled=false;this.widgets.templateOutputText.disabled=false;this.widgets.executeButton.disabled=false;this.showResultTable(res.json.result);YAHOO.util.Dom.removeClass(this.widgets.scriptOutput,"jserror");this.runLikeCrazy();},scope:this},failureCallback:{fn:function(res){this.showLoadingAjaxSpinner(false);this.printExecutionStats();var result=YAHOO.lang.JSON.parse(res.serverResponse.responseText);this.markJSError(result);this.markFreemarkerError(result);this.clearOutput();this.setOutputText(result.status.code+" "+result.status.name+"\nStacktrace-Details:\n"+result.callstack[1]+"\n\n"+result.status.description+"\n"+result.message);this.widgets.scriptOutput.disabled=false;this.widgets.executeButton.disabled=false;Dom.addClass(this.widgets.scriptOutput,"jserror");this.widgets.outputTabs.selectTab(0);this.runLikeCrazy();},scope:this}});},runLikeCrazy:function(){var me=this;if(this.widgets.config.runlikecrazy.value>0){window.setTimeout(function(){me.onExecuteClick();},this.widgets.config.runlikecrazy.value);}},markJSError:function(result){var regex=/js#([\d])/;var callStackLineIndicator=regex.exec(result.callstack[1]);if(callStackLineIndicator){this.widgets.inputTabs.selectTab(0);this.widgets.codeMirrorScript.focus();var line=callStackLineIndicator[1]-1;if(this.widgets.codeMirrorScript.somethingSelected()){line=line+this.widgets.codeMirrorScript.getCursor().line-1;}var selectionEnd=this.widgets.codeMirrorScript.getLineHandle(line).text.length;var from={line:line,ch:0};var to={line:line,ch:selectionEnd};this.widgets.codeMirrorScript.markText(from,to,{clearOnEnter:"true",className:"CodeMirror-lint-span-error",__annotation:{from:from,to:to,severity:"error",message:result.callstack[1]}});}},markFreemarkerError:function(result){var callstack=result.callstack;if(callstack){for(var i=0;i<callstack.length;i++){regex=/line (\d*), column (\d*)/;callStackLineIndicator=regex.exec(callstack[i]);if(callStackLineIndicator){this.widgets.inputTabs.selectTab(1);this.widgets.codeMirrorTemplate.focus();var line=callStackLineIndicator[1]-1;var selectionEnd=this.widgets.codeMirrorTemplate.getLineHandle(line).text.length;this.widgets.codeMirrorTemplate.markText({line:line,ch:0},{line:line,ch:selectionEnd},{clearOnEnter:"true",className:"CodeMirror-lint-span-error",__annotation:{message:callstack[i]}});break;}}}},showLoadingAjaxSpinner:function(showSpinner){var spinner=Dom.get(this.id+"-spinner");Dom.setStyle(spinner,"display",showSpinner?"inline":"none");},printExecutionStats:function(json){this.executeEndTime=new Date();var overallPerf=this.executeEndTime-this.executeStartTime;var webscriptPerf="-";var fmPerf="-";var scriptPerf="-";var networkPerf="-";var serverCodePerf="-";if(json){scriptPerf=json.scriptPerf;fmPerf=json.freemarkerPerf;webscriptPerf=json.webscriptPerf;networkPerf=overallPerf-webscriptPerf;serverCodePerf=webscriptPerf-scriptPerf-fmPerf;}var overallEl=YAHOO.lang.substitute(this.template,{name:this.msg("label.stats.executed.in"),value:overallPerf+"ms"});var scriptEl=YAHOO.lang.substitute(this.template,{name:this.msg("label.stats.jscript.executed.in"),value:scriptPerf+"ms"});var fmEl=YAHOO.lang.substitute(this.template,{name:this.msg("label.stats.freemarker.executed.in"),value:fmPerf+"ms"});var codeEl=YAHOO.lang.substitute(this.template,{name:this.msg("label.stats.serverCode.executed.in"),value:serverCodePerf+"ms"});var networkEl=YAHOO.lang.substitute(this.template,{name:this.msg("label.stats.network.executed.in"),value:networkPerf+"ms"});var text=overallEl+scriptEl+fmEl+codeEl+networkEl;this.widgets.statsModule.setBody(text);},loadDemoScript:function ACJC_loadDemoScript(){this.widgets.codeMirrorScript.setValue("var nodes = search.luceneSearch('@name:alfresco');\n\nfor each(var node in nodes) {\n    logger.log(node.name + ' (' + node.typeShort + '): ' + node.nodeRef);\n}\n");},loadDemoTemplate:function ACJC_loadDemoTemplate(){this.widgets.codeMirrorTemplate.setValue("no template");},onLoadScriptClick:function ACJC_onLoadScriptClick(p_sType,p_aArgs,self){var callback={success:function(o){self.widgets.codeMirrorScript.setValue(o.responseText);},failure:function(o){text:self.msg("error.script.load",filename);},scope:this};var nodeRef=p_aArgs[1].value;if(nodeRef=="NEW"){self.loadDemoScript.call(self);}else{var url=Alfresco.constants.PROXY_URI+"api/node/content/"+nodeRef.replace("://","/");YAHOO.util.Connect.asyncRequest("GET",url,callback);}},onThemeSelection:function ACJC_onThemeSelection(p_sType,p_aArgs,self){var theme=p_aArgs[1].value;self.widgets.codeMirrorScript.setOption("theme",theme);self.widgets.codeMirrorTemplate.setOption("theme",theme);},saveAsExistingScript:function ACJC_saveAsExistingScript(filename,nodeRef){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/node/content/"+nodeRef.replace("://","/"),method:Alfresco.util.Ajax.PUT,dataStr:this.widgets.scriptInput.value,requestContentType:"text/javascript",successMessage:this.msg("message.save.successful",filename),failureMessage:this.msg("error.script.save",filename)});},saveAsNewScript:function ACJC_saveAsNewScript(filename){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"de/fme/jsconsole/createscript.json?name="+encodeURIComponent(filename),method:Alfresco.util.Ajax.PUT,dataStr:this.widgets.scriptInput.value,requestContentType:"text/javascript",successMessage:this.msg("message.save.successful",filename),failureMessage:this.msg("error.script.save",filename)});},onSaveScriptClick:function ACJC_onSaveScriptClick(p_sType,p_aArgs,self){self.widgets.codeMirrorScript.save();var menuItem=p_aArgs[1];var filename=menuItem.cfg.getProperty("text");var nodeRef=menuItem.value;if(nodeRef=="NEW"){Alfresco.util.PopupManager.getUserInput({title:self.msg("title.save.choose.filename"),text:self.msg("message.save.choose.filename"),input:"text",callback:{fn:self.saveAsNewScript,obj:[],scope:self}});}else{Alfresco.util.PopupManager.displayPrompt({title:self.msg("title.confirm.save"),text:self.msg("message.confirm.save",filename),buttons:[{text:self.msg("button.save"),handler:function ACJC_onSaveScriptClick_save(){this.destroy();self.saveAsExistingScript(filename,nodeRef);}},{text:self.msg("button.cancel"),handler:function ACJC_onSaveScriptClick_cancel(){this.destroy();},isDefault:true}]});}},onSelectDestinationClick:function ACJC_onSelectDestinationClick(e,p_obj){if(!this.widgets.destinationDialog){this.widgets.destinationDialog=new Alfresco.module.DoclibGlobalFolder(this.id+"-selectDestination");var allowedViewModes=[Alfresco.module.DoclibGlobalFolder.VIEW_MODE_REPOSITORY];this.widgets.destinationDialog.setOptions({allowedViewModes:allowedViewModes,siteId:this.options.siteId,containerId:this.options.containerId,title:this.msg("title.destinationDialog"),nodeRef:"alfresco://company/home"});}var pathNodeRef=this.widgets.nodeField.value;this.widgets.destinationDialog.setOptions({pathNodeRef:pathNodeRef?new Alfresco.util.NodeRef(pathNodeRef):null});this.widgets.destinationDialog.showDialog();},onDestinationSelected:function ACJC_onDestinationSelected(layer,args){if($hasEventInterest(this.widgets.destinationDialog,args)){var obj=args[1];if(obj!==null){this.widgets.nodeField.value=obj.selectedFolder.nodeRef;this.widgets.pathField.innerHTML=obj.selectedFolder.path;}}}});function forEach(arr,f){for(var i=0,e=arr.length;i<e;++i){f(arr[i]);}}function arrayContains(arr,item){if(!Array.prototype.indexOf){var i=arr.length;while(i--){if(arr[i]===item){return true;}}return false;}return arr.indexOf(item)!=-1;}})();